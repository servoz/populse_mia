
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>populse_mia.data_manager.data_loader &#8212; populse_mia 1.2.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../index.html">
          <span>populse_mia 1.2.1 documentation</span></a></h1>
        <h2 class="heading"><span>populse_mia.data_manager.data_loader</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for populse_mia.data_manager.data_loader</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*- #</span>
<span class="sd">&quot;&quot;&quot;Module to handle the importation from MRIFileManager and its progress</span>

<span class="sd">Contains:</span>
<span class="sd">    Class:</span>
<span class="sd">        -ImportProgress : Inherit from QProgressDialog and handle the</span>
<span class="sd">        progress bar</span>
<span class="sd">        -ImportWorker : Inherit from QThread and manage the threads</span>
<span class="sd">    Methods:</span>
<span class="sd">        -read_log : Show the evolution of the progress bar and returns its</span>
<span class="sd">        feedback</span>
<span class="sd">        -tags_from_file : Returns a list of [tag, value] contained in a Json</span>
<span class="sd">        file</span>
<span class="sd">        -verify_scans : Check if the project&#39;s scans have been modified</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>  <span class="c1"># To generate the md5 of each path</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="c1"># PyQt5 imports</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="k">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">pyqtSignal</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="k">import</span> <span class="n">QProgressDialog</span>

<span class="c1"># Populse_MIA imports</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.project</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">TAG_CHECKSUM</span><span class="p">,</span> <span class="n">TAG_TYPE</span><span class="p">,</span>
    <span class="n">TAG_FILENAME</span><span class="p">,</span> <span class="n">TYPE_NII</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.database_mia</span> <span class="k">import</span> <span class="p">(</span><span class="n">TAG_ORIGIN_BUILTIN</span><span class="p">,</span>
                                                   <span class="n">TAG_ORIGIN_USER</span><span class="p">)</span>

<span class="c1"># Populse_db imports</span>
<span class="kn">from</span> <span class="nn">populse_db.database</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">FIELD_TYPE_STRING</span><span class="p">,</span> <span class="n">FIELD_TYPE_DATETIME</span><span class="p">,</span> <span class="n">FIELD_TYPE_DATE</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_TIME</span><span class="p">,</span> <span class="n">FIELD_TYPE_LIST_STRING</span><span class="p">,</span> <span class="n">FIELD_TYPE_INTEGER</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_INTEGER</span><span class="p">,</span> <span class="n">FIELD_TYPE_FLOAT</span><span class="p">,</span> <span class="n">FIELD_TYPE_LIST_FLOAT</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_BOOLEAN</span><span class="p">,</span> <span class="n">FIELD_TYPE_LIST_BOOLEAN</span><span class="p">,</span> <span class="n">FIELD_TYPE_LIST_DATE</span><span class="p">,</span>
    <span class="n">FIELD_TYPE_LIST_DATETIME</span><span class="p">,</span> <span class="n">FIELD_TYPE_LIST_TIME</span><span class="p">)</span>


<div class="viewcode-block" id="ImportProgress"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportProgress">[docs]</a><span class="k">class</span> <span class="nc">ImportProgress</span><span class="p">(</span><span class="n">QProgressDialog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle the progress bar.</span>

<span class="sd">    Attributes;</span>
<span class="sd">        :param project: A Project object</span>

<span class="sd">    Methods:</span>
<span class="sd">        - onProgress : Set the import progressbar value.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ImportProgress.__init__"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportProgress.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ImportProgress</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;Please wait while the paths are being imported...&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Importing the paths&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Window</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">WindowTitleHint</span> <span class="o">|</span>
                            <span class="n">Qt</span><span class="o">.</span><span class="n">CustomizeWindowHint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumDuration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">ImportWorker</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">notifyProgress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onProgress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="ImportProgress.onProgress"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportProgress.onProgress">[docs]</a>    <span class="k">def</span> <span class="nf">onProgress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signal to set the import progressbar value&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ImportWorker"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportWorker">[docs]</a><span class="k">class</span> <span class="nc">ImportWorker</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage threads.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        :param project: A Project object</span>
<span class="sd">        ;param progress: An ImportProgress object</span>

<span class="sd">    Methods:</span>
<span class="sd">        - run : Override the QThread run method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Used to fill the progress bar</span>
    <span class="n">notifyProgress</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<div class="viewcode-block" id="ImportWorker.__init__"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportWorker.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="c1"># scans_added should always be accessed through the lock, and copied</span>
        <span class="c1"># before releasing the lock, because its value will change inside</span>
        <span class="c1"># the thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans_added</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="ImportWorker.run"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.ImportWorker.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override the QThread run method. Executed when the worker is</span>
<span class="sd">        started, fills the database and updates the progress.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="n">raw_data_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span>
                                                       <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_data&#39;</span><span class="p">))</span>

        <span class="c1"># Checking all the export logs from MRIManager and taking the most</span>
        <span class="c1"># recent</span>
        <span class="n">list_logs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_data_folder</span><span class="p">,</span> <span class="s2">&quot;logExport*.json&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_logs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">list_dict_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_to_read</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">list_logs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_to_read</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">list_dict_log</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># For history</span>
        <span class="n">historyMaker</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">historyMaker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;add_scans&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scans_added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values_added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tags_added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tags_names_added</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">documents</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># List of tags to remove</span>
        <span class="n">tags_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Dataset data file&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset header file&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">dict_log</span> <span class="ow">in</span> <span class="n">list_dict_log</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">dict_log</span><span class="p">[</span><span class="s1">&#39;StatusExport&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Export ok&quot;</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">dict_log</span><span class="p">[</span><span class="s1">&#39;NameFile&#39;</span><span class="p">]</span>
                <span class="n">path_name</span> <span class="o">=</span> <span class="n">raw_data_folder</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nii&quot;</span><span class="p">,</span>
                          <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scan_file</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">scan_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">original_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_data_folder</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;.nii&quot;</span><span class="p">)</span>
                <span class="n">file_database_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>

                <span class="n">document_not_existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">file_database_path</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">document_not_existing</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                        <span class="c1"># Scan added to history</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scans_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_database_path</span><span class="p">)</span>

                <span class="n">documents</span><span class="p">[</span><span class="n">file_database_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">documents</span><span class="p">[</span><span class="n">file_database_path</span><span class="p">][</span><span class="n">TAG_FILENAME</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">file_database_path</span>

                <span class="c1"># For each tag in each scan</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_from_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">path_name</span><span class="p">):</span>

                    <span class="c1"># We do the tag only if it&#39;s not in the tags to remove</span>
                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags_to_remove</span><span class="p">:</span>
                        <span class="n">properties</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">unit</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_STRING</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">unit</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="n">unit</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="nb">format</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
                            <span class="n">tag_type</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_STRING</span>
                            <span class="n">description</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">description</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="n">tag_name</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># Creating date types</span>
                        <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">format</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;yyyy&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y&quot;</span><span class="p">)</span>
                            <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;MM&quot;</span><span class="p">,</span> <span class="s2">&quot;%m&quot;</span><span class="p">)</span>
                            <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;dd&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;HH&quot;</span><span class="p">,</span> <span class="s2">&quot;%H&quot;</span><span class="p">)</span>
                            <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;%M&quot;</span><span class="p">)</span>
                            <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;ss&quot;</span><span class="p">,</span> <span class="s2">&quot;%S&quot;</span><span class="p">)</span>
                            <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SSS&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;%Y&quot;</span> <span class="ow">in</span> <span class="nb">format</span> <span class="ow">and</span> <span class="s2">&quot;%m&quot;</span> <span class="ow">in</span> <span class="nb">format</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="ow">in</span>
                                    <span class="nb">format</span> <span class="ow">and</span> <span class="s2">&quot;%H&quot;</span> <span class="ow">in</span> <span class="nb">format</span> <span class="ow">and</span>
                                    <span class="s2">&quot;%M&quot;</span> <span class="ow">in</span> <span class="nb">format</span> <span class="ow">and</span> <span class="s2">&quot;%S&quot;</span> <span class="ow">in</span> <span class="nb">format</span><span class="p">):</span>
                                <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_DATETIME</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;%Y&quot;</span> <span class="ow">in</span> <span class="nb">format</span> <span class="ow">and</span> <span class="s2">&quot;%m&quot;</span> <span class="ow">in</span> <span class="nb">format</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span>
                                    <span class="ow">in</span> <span class="nb">format</span><span class="p">):</span>
                                <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_DATE</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;%H&quot;</span> <span class="ow">in</span> <span class="nb">format</span> <span class="ow">and</span> <span class="s2">&quot;%M&quot;</span> <span class="ow">in</span> <span class="nb">format</span> <span class="ow">and</span> <span class="s2">&quot;%S&quot;</span>
                                    <span class="ow">in</span> <span class="nb">format</span><span class="p">):</span>
                                <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_TIME</span>

                        <span class="k">if</span> <span class="n">tag_name</span> <span class="o">!=</span> <span class="s2">&quot;Json_Version&quot;</span><span class="p">:</span>
                            <span class="c1"># Preparing value and type</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_STRING</span><span class="p">:</span>
                                    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_STRING</span>
                                <span class="k">elif</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_INTEGER</span><span class="p">:</span>
                                    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_INTEGER</span>
                                <span class="k">elif</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_FLOAT</span><span class="p">:</span>
                                    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_FLOAT</span>
                                <span class="k">elif</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_BOOLEAN</span><span class="p">:</span>
                                    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_BOOLEAN</span>
                                <span class="k">elif</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_DATE</span><span class="p">:</span>
                                    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_DATE</span>
                                <span class="k">elif</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_DATETIME</span><span class="p">:</span>
                                    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_DATETIME</span>
                                <span class="k">elif</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_TIME</span><span class="p">:</span>
                                    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">FIELD_TYPE_LIST_TIME</span>
                                <span class="n">value_prepared</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">value_single</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                                    <span class="n">value_prepared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_single</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value_prepared</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_DATETIME</span> <span class="ow">or</span> <span class="n">tag_type</span> <span class="o">==</span>
                                <span class="n">FIELD_TYPE_DATE</span> <span class="ow">or</span>
                                <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_TIME</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_TIME</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                                <span class="k">elif</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">FIELD_TYPE_DATE</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

                        <span class="c1"># TODO time lists</span>

                        <span class="n">tag_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span>
                            <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">tag_row</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tag_name</span> <span class="ow">not</span> <span class="ow">in</span>
                                <span class="n">tags_names_added</span><span class="p">):</span>
                            <span class="c1"># Adding the tag as it&#39;s not in the database yet</span>
                            <span class="n">tags_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">,</span>
                                 <span class="n">description</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">TAG_ORIGIN_BUILTIN</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
                                 <span class="kc">None</span><span class="p">])</span>
                            <span class="n">tags_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">,</span>
                                 <span class="n">description</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">TAG_ORIGIN_BUILTIN</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
                                 <span class="kc">None</span><span class="p">])</span>
                            <span class="n">tags_names_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>

                        <span class="c1"># The value is accepted if it&#39;s not empty or null</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">document_not_existing</span><span class="p">:</span>
                                <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">file_database_path</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                     <span class="n">value</span><span class="p">])</span>  <span class="c1"># Value added to history</span>
                            <span class="n">documents</span><span class="p">[</span><span class="n">file_database_path</span><span class="p">][</span><span class="n">tag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="k">if</span> <span class="n">document_not_existing</span><span class="p">:</span>
                    <span class="c1"># Tags added manually</span>
                    <span class="c1"># Value added to history</span>
                    <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">file_database_path</span><span class="p">,</span> <span class="n">TAG_CHECKSUM</span><span class="p">,</span> <span class="n">original_md5</span><span class="p">,</span>
                         <span class="n">original_md5</span><span class="p">])</span>
                    <span class="c1"># Value added to history</span>
                    <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">file_database_path</span><span class="p">,</span> <span class="n">TAG_TYPE</span><span class="p">,</span>
                                         <span class="n">TYPE_NII</span><span class="p">,</span> <span class="n">TYPE_NII</span><span class="p">])</span>
                <span class="n">documents</span><span class="p">[</span><span class="n">file_database_path</span><span class="p">][</span><span class="n">TAG_CHECKSUM</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_md5</span>
                <span class="n">documents</span><span class="p">[</span><span class="n">file_database_path</span><span class="p">][</span><span class="n">TAG_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">TYPE_NII</span>

        <span class="c1"># Missing values added thanks to default values</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="n">TAG_ORIGIN_USER</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_added</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                                <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Value added to history</span>
                        <span class="n">values_added</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">scan</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">tag</span><span class="o">.</span><span class="n">default_value</span><span class="p">,</span>
                                             <span class="n">tag</span><span class="o">.</span><span class="n">default_value</span><span class="p">])</span>
                        <span class="n">documents</span><span class="p">[</span><span class="n">scan</span><span class="p">][</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">default_value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">notifyProgress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_fields</span><span class="p">(</span><span class="n">tags_added</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">notifyProgress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">current_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_documents_names</span><span class="p">(</span>
            <span class="n">COLLECTION_CURRENT</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">current_paths</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                                                     <span class="n">document</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
                                                     <span class="n">document</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">documents</span><span class="p">[</span>
                <span class="n">document</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">documents</span><span class="p">[</span>
                <span class="n">document</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">notifyProgress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># For history</span>
        <span class="n">historyMaker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_added</span><span class="p">)</span>
        <span class="n">historyMaker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values_added</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">undos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">historyMaker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">redos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Data export duration in the database:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;read_log time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div></div>
        <span class="c1"># print(&quot;read_log time: &quot; + str(time() - begin))</span>

        <span class="c1"># pr.disable()</span>
        <span class="c1"># pr.print_stats(sort=&#39;time&#39;)</span>
        <span class="c1"># prof.print_stats()</span>


<div class="viewcode-block" id="read_log"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.read_log">[docs]</a><span class="k">def</span> <span class="nf">read_log</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">main_window</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the evolution of the progress bar and returns its feedback, a list</span>
<span class="sd">    of the paths to each data file that was loaded.</span>

<span class="sd">    :param project: current project in the software</span>
<span class="sd">    :param main_window: software&#39;s main window</span>
<span class="sd">    :returns: the scans that have been added</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">main_window</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">ImportProgress</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="n">main_window</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">main_window</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">main_window</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="n">scans_added</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">scans_added</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scans_added</span></div>


<span class="c1"># def save_project(project):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Saves the modifications of the project</span>
<span class="c1">#</span>
<span class="c1">#     :param project: current project in the software</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     project.saveModifications()</span>

<div class="viewcode-block" id="tags_from_file"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.tags_from_file">[docs]</a><span class="k">def</span> <span class="nf">tags_from_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of [tag, value] contained in a Json file.</span>

<span class="sd">    :param file_path: file path of the Json file (without the extension)</span>
<span class="sd">    :param path: project path</span>
<span class="sd">    :returns: a list of the Json tags of the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">json_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">json_tags</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">json_tags</span></div>


<div class="viewcode-block" id="verify_scans"><a class="viewcode-back" href="../../../populse_mia.data_manager.html#populse_mia.data_manager.data_loader.verify_scans">[docs]</a><span class="k">def</span> <span class="nf">verify_scans</span><span class="p">(</span><span class="n">project</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if the project&#39;s scans have been modified.</span>

<span class="sd">    :param project: current project in the software</span>
<span class="sd">    :returns: the list of scans that have been modified</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Returning the files that are problematic</span>
    <span class="n">return_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_documents_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">):</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="n">scan</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="c1"># If the file exists, we do the checksum</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scan_file</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">scan_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">actual_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

            <span class="n">initial_checksum</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                                                         <span class="n">scan</span><span class="p">,</span> <span class="n">TAG_CHECKSUM</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_checksum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">actual_md5</span> <span class="o">!=</span> <span class="n">initial_checksum</span><span class="p">:</span>
                <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, we directly add the file in the list</span>
            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">return_list</span></div>


</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, populse.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>